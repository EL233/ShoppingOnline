<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>个人中心</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <header id="navbar">
        <div id="language-switcher">
            <select id="lang-select">
                <option value="zh" selected>中文</option>
                <option value="en">English</option>
            </select>
        </div>
        <nav id="nav-links">
            <a href="index.html">返回首页</a>
            <a href="shopping-cart.html" data-translate="shopping-cart">购物车</a>
            <a href="#" onclick="showModal('contact-us')" data-translate="contact-us">联系我们</a>
            <a href="search.html" data-translate="search">搜索</a>
        </nav>
        <div id="homeIcon">
            <a href="index.html">
                <img src="images/123.JPG" alt="logo"/>
            </a>
        </div>
    </header>

    <main class="page active" style="margin-top: 120px;">
        <div id="personal-center">
            <h2>个人中心</h2>
            
            <!-- 登录类型选择 -->
            <div id="login-type-selection" class="login-type-buttons">
                <button class="login-type-btn active" onclick="selectLoginType('user')" id="user-login-btn">用户登录</button>
                <button class="login-type-btn" onclick="selectLoginType('admin')" id="admin-login-btn">管理员登录</button>
            </div>

            <!-- 登录表单 -->
            <form id="login-form">
                <input type="email" id="login-email" placeholder="邮箱" required>
                <input type="password" id="login-password" placeholder="密码" required>
                <div class="forgot-password">
                    <a href="reset-password.html">忘记密码？</a>
                </div>
                <button type="submit" onclick="handleLogin(event)">登录</button>
                <div id="login-error" style="color: red; margin-top: 10px;"></div>
            </form>

            <!-- 用户信息 -->
            <div id="user-profile" style="display: none;">
                <h3>欢迎，<span id="username"></span></h3>
                <div class="profile-menu">
                    <ul>
                        <li><a href="shopping-cart.html">我的购物车</a></li>
                        <li><a href="#" onclick="showModal('contact-us')">联系我们</a></li>
                        <li><a href="#" onclick="logoutUser()">退出登录</a></li>
                    </ul>
                </div>
            </div>

            <!-- 注册提示 -->
            <div class="register-prompt">
                <p>还没有账号？<a href="register.html">立即注册</a></p>
            </div>
        </div>
    </main>

    <!-- 联系我们弹出框 -->
    <div id="contact-us" class="modal">
        <div class="modal-content">
            <h3>谢谢您的联络，请留下要咨询的问题</h3>
            <input type="text" placeholder="输入你的电子邮箱" id="contact-email">
            <textarea placeholder="输入你想告诉我们的..."></textarea>
            <button onclick="sendContact()">发送</button>
            <button onclick="closeModal('contact-us')" style="background: #6c757d;">关闭</button>
        </div>
    </div>

    <script>
        // 简化的API调用函数
        async function apiRequest(url, method = 'GET', data = null) {
            const headers = {
                'Content-Type': 'application/json'
            };

            const token = localStorage.getItem('token');
            if (token) {
                headers['Authorization'] = `Bearer ${token}`;
            }

            const config = {
                method,
                headers,
                mode: 'cors',
                credentials: 'include'
            };

            if (data) {
                config.body = JSON.stringify(data);
            }

            try {
                const response = await fetch(`http://localhost:5001/api${url}`, config);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                return await response.json();
            } catch (error) {
                console.error('API请求失败:', error);
                throw error;
            }
        }

        // 用户API
        const userApi = {
            login: (email, password) => apiRequest('/users/login', 'POST', { email, password }),
            getCurrentUser: () => apiRequest('/users/me')
        };

        // 语言切换功能
        function setupLanguageSwitcher() {
            const langSelect = document.getElementById('lang-select');
            if (!langSelect) return;
            
            const elementsToTranslate = document.querySelectorAll('[data-translate]');
            const translations = {
                'zh': {
                    'personal-center': '个人中心',
                    'shopping-cart': '购物车',
                    'contact-us': '联系我们',
                    'search': '搜索'
                },
                'en': {
                    'personal-center': 'Personal Center',
                    'shopping-cart': 'Shopping Cart',
                    'contact-us': 'Contact Us',
                    'search': 'Search'
                }
            };

            function setLanguage(lang) {
                elementsToTranslate.forEach(element => {
                    const key = element.getAttribute('data-translate');
                    if (translations[lang] && translations[lang][key]) {
                        element.textContent = translations[lang][key];
                    }
                });
            }

            langSelect.addEventListener('change', function() {
                setLanguage(this.value);
            });

            setLanguage('zh');
        }

        // 显示弹出框
        function showModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.style.display = 'block';
            }
        }

        // 关闭弹出框
        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.style.display = 'none';
            }
        }

        // 发送联系信息
        function sendContact() {
            const email = document.getElementById('contact-email');
            if (email && email.value) {
                alert('感谢您的联络，我们会尽快回复！');
                closeModal('contact-us');
            } else {
                alert('请输入您的邮箱');
            }
        }

        // 点击模态框外部关闭
        function setupModalClose() {
            window.onclick = function(event) {
                const modals = document.querySelectorAll('.modal');
                modals.forEach(modal => {
                    if (event.target === modal) {
                        modal.style.display = 'none';
                    }
                });
            }
        }

        // 选择登录类型
        function selectLoginType(type) {
            document.querySelectorAll('.login-type-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            localStorage.setItem('loginType', type);
            
            // 根据登录类型显示不同的提示
            const emailInput = document.getElementById('login-email');
            const passwordInput = document.getElementById('login-password');
            
            if (type === 'admin') {
                emailInput.placeholder = '管理员邮箱 (admin@example.com)';
                passwordInput.placeholder = '管理员密码 (admin123)';
            } else {
                emailInput.placeholder = '用户邮箱';
                passwordInput.placeholder = '用户密码';
            }
        }

        // 处理登录
        async function handleLogin(event) {
            event.preventDefault();
            
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            const loginType = localStorage.getItem('loginType') || 'user';
            
            if (!email || !password) {
                document.getElementById('login-error').textContent = '请输入邮箱和密码';
                return;
            }
            
            try {
                console.log('发送登录请求...');
                document.getElementById('login-error').textContent = '正在登录，请稍候...';
                
                // 检查管理员登录
                if (loginType === 'admin') {
                    if (email === 'admin@example.com' && password === 'admin123') {
                        // 模拟管理员登录成功
                        const adminToken = 'admin_token_' + Date.now();
                        localStorage.setItem('token', adminToken);
                        localStorage.setItem('loginType', 'admin');
                        alert('管理员登录成功！');
                        window.location.href = 'admin-dashboard.html';
                        return;
                    } else {
                        document.getElementById('login-error').textContent = '管理员账号或密码错误';
                        return;
                    }
                }
                
                // 普通用户登录
                const response = await userApi.login(email, password);
                console.log('登录响应:', response);
                
                if (response.success) {
                    console.log('登录成功:', response);
                    localStorage.setItem('token', response.token);
                    localStorage.setItem('loginType', 'user');
                    document.getElementById('username').textContent = response.user.email;
                    document.getElementById('login-type-selection').style.display = 'none';
                    document.getElementById('login-form').style.display = 'none';
                    document.getElementById('user-profile').style.display = 'block';
                    alert('登录成功！');
                }
            } catch (error) {
                console.error('登录失败:', error);
                document.getElementById('login-error').textContent = error.message || '登录失败，请检查邮箱和密码';
            }
        }
        
        // 用户退出登录
        function logoutUser() {
            console.log('退出登录');
            localStorage.removeItem('token');
            localStorage.removeItem('loginType');
            document.getElementById('login-form').style.display = 'block';
            document.getElementById('user-profile').style.display = 'none';
            document.getElementById('login-email').value = '';
            document.getElementById('login-password').value = '';
            document.getElementById('login-error').textContent = '';
        }

        // 检查登录状态
        async function checkLoginStatus() {
            const token = localStorage.getItem('token');
            const loginType = localStorage.getItem('loginType');
            
            if (token) {
                try {
                    console.log('发现token，尝试获取用户信息...');
                    // 获取用户信息
                    const response = await userApi.getCurrentUser();
                    if (response.success) {
                        console.log('获取用户信息成功:', response.user);
                        document.getElementById('username').textContent = response.user.email;
                        
                        if (loginType === 'admin') {
                            // 管理员登录，跳转到管理后台
                            window.location.href = 'admin-dashboard.html';
                            return true;
                        } else {
                            // 用户登录，显示用户界面
                            document.getElementById('login-type-selection').style.display = 'none';
                            document.getElementById('login-form').style.display = 'none';
                            document.getElementById('user-profile').style.display = 'block';
                            return true;
                        }
                    }
                } catch (error) {
                    console.error('获取用户信息失败:', error);
                    document.getElementById('login-error').textContent = `获取用户信息失败: ${error.message || '未知错误'}`;
                    localStorage.removeItem('token');
                    localStorage.removeItem('loginType');
                }
            } else {
                console.log('未找到token');
            }
            return false;
        }

        // 页面加载后初始化
        document.addEventListener('DOMContentLoaded', function() {
            setupLanguageSwitcher();
            setupModalClose();
            checkLoginStatus();
        });
    </script>
</body>
</html>
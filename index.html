<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EL杂货铺</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script>
</head>
<body>
    <header id="navbar">
        <div id="language-switcher">
            <select id="lang-select">
                <option value="zh" selected>中文</option>
                <option value="en">English</option>
            </select>
        </div>
        <nav id="nav-links">
            <a href="personal-center.html" data-translate="personal-center">个人中心</a>
            <a href="shopping-cart.html" data-translate="shopping-cart">购物车</a>
            <a href="#" onclick="showModal('contact-us')" data-translate="contact-us">联系我们</a>
            <a href="search.html" data-translate="search">搜索</a>
        </nav>
        <div id="homeIcon">
            <img src="images/123.JPG" alt="logo"/>
        </div>
    </header>
    
    <div class="banner">
        <ul class="slider" id="carousel-slider">
            <!-- 轮播图内容将通过JavaScript动态加载 -->
        </ul>
        <div class="dots" id="carousel-dots">
            <!-- 轮播图指示点将通过JavaScript动态生成 -->
        </div>
        <a href="javascript:;" class="arrow-l">&lt;</a>
        <a href="javascript:;" class="arrow-r">&gt;</a>
    </div>
    
    <h2 class="section-title">精选商品</h2>
    <div id="product-section" class="product-section">
    </div>

    <!-- 联系我们弹出框 -->
    <div id="contact-us" class="modal">
        <div class="modal-content">
            <h3>谢谢您的联络，请留下要咨询的问题</h3>
            <input type="text" placeholder="输入你的电子邮箱" id="contact-email">
            <textarea placeholder="输入你想告诉我们的..."></textarea>
            <button onclick="sendContact()">发送</button>
            <button onclick="closeModal('contact-us')" style="background: #6c757d;">关闭</button>
        </div>
    </div>

    <script type="module">
        import { 
            setupLanguageSwitcher,
            getProducts,
            showModal,
            closeModal,
            sendContact,
            setupModalClose,
            initCart
        } from './core.js';
    
        // 轮播图变量
        let currentSlide = 0;
        let slideInterval;
        let totalSlides = 0;
    
        // 加载精选商品作为轮播图
        async function loadFeaturedProducts() {
            try {
                const response = await fetch('http://localhost:5001/api/products?featured=true');
                if (response.ok) {
                    const data = await response.json();
                    if (data.success && data.data.length > 0) {
                        displayFeaturedProducts(data.data);
                    } else {
                        // 如果没有精选商品，使用默认商品
                        displayDefaultProducts();
                    }
                } else {
                    displayDefaultProducts();
                }
            } catch (error) {
                console.error('加载精选商品失败:', error);
                displayDefaultProducts();
            }
        }

        // 显示精选商品
        function displayFeaturedProducts(products) {
            const slider = document.getElementById('carousel-slider');
            const dotsContainer = document.getElementById('carousel-dots');
            
            slider.innerHTML = '';
            dotsContainer.innerHTML = '';

            // 只显示前4个精选商品
            const featuredProducts = products.slice(0, 4);

            featuredProducts.forEach((product, index) => {
                // 创建轮播图项
                const item = document.createElement('li');
                item.className = 'carousel-item';
                item.setAttribute('data-product-id', product._id);
                item.innerHTML = `<img src="${product.image}" alt="${product.title}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 10px;">`;
                
                // 添加点击事件
                item.style.cursor = 'pointer';
                item.addEventListener('click', () => {
                    window.location.href = `product-detail.html?id=${product._id}`;
                });
                
                slider.appendChild(item);

                // 创建指示点
                const dot = document.createElement('span');
                if (index === 0) dot.classList.add('active');
                dotsContainer.appendChild(dot);
            });

            // 更新轮播图数量
            totalSlides = featuredProducts.length;
            initSlider();
        }

        // 显示默认商品
        function displayDefaultProducts() {
            const defaultProducts = [
                { title: '明日香', image: 'images/Asuka.png', _id: 'default1' },
                { title: '可爱路飞', image: 'images/GXMD576a0AAU7as.jpeg', _id: 'default2' },
                { title: '老八抢饮料', image: 'images/GXO06eYb0AAarC3.jpeg', _id: 'default3' },
                { title: '赛博朋克边缘行者', image: 'images/GXPPMj6bgAM_GTU.jpeg', _id: 'default4' }
            ];
            displayFeaturedProducts(defaultProducts);
        }

        // 初始化轮播图
        function initSlider() {
            const slider = document.querySelector('.slider');
            const dots = document.querySelectorAll('.dots span');
            const arrowLeft = document.querySelector('.arrow-l');
            const arrowRight = document.querySelector('.arrow-r');
            const banner = document.querySelector('.banner');

            function updateSlider() {
                if (totalSlides > 0) {
                    slider.style.transform = `translateX(-${currentSlide * (100 / totalSlides)}%)`;
                    dots.forEach((dot, index) => {
                        dot.classList.toggle('active', index === currentSlide);
                    });
                }
            }

            function nextSlide() {
                currentSlide = (currentSlide + 1) % totalSlides;
                updateSlider();
            }

            function prevSlide() {
                currentSlide = (currentSlide - 1 + totalSlides) % totalSlides;
                updateSlider();
            }

            arrowRight.addEventListener('click', nextSlide);
            arrowLeft.addEventListener('click', prevSlide);

            dots.forEach((dot, index) => {
                dot.addEventListener('click', () => {
                    currentSlide = index;
                    updateSlider();
                });
            });

            // 自动轮播
            slideInterval = setInterval(nextSlide, 3000);

            banner.addEventListener('mouseenter', () => {
                clearInterval(slideInterval);
            });

            banner.addEventListener('mouseleave', () => {
                slideInterval = setInterval(nextSlide, 3000);
            });

            updateSlider();
        }

        // 加载商品
        async function loadProducts() {
            const productSection = document.getElementById('product-section');
            productSection.innerHTML = '';

            try {
                const products = await getProducts();
                products.forEach(product => {
                    const item = document.createElement('div');
                    item.className = 'product-item';
                    item.innerHTML = `
                        <img src="${product.image}" alt="${product.title}">
                        <h3>${product.title}</h3>
                    `;
                    // 修改为跳转到商品详情页，并传递商品ID
                    item.addEventListener('click', () => {
                        window.location.href = `product-detail.html?id=${product._id || product.id}`;
                    });
                    productSection.appendChild(item);
                });
            } catch (error) {
                console.error('加载商品失败:', error);
                productSection.innerHTML = '<p>商品加载失败，请刷新页面重试</p>';
            }
        }
    
        // 页面加载后初始化
        document.addEventListener('DOMContentLoaded', function() {
            loadFeaturedProducts(); // 加载精选商品作为轮播图
            loadProducts();
            setupLanguageSwitcher();
            setupModalClose();
            initCart(); // 初始化购物车数据
            
            // 全局函数
            window.showModal = showModal;
            window.closeModal = closeModal;
            window.sendContact = sendContact;
        });
    </script>
</body>
</html>